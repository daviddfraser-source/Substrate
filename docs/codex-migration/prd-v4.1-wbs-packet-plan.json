{
  "metadata": {
    "plan_id": "PRD-V4.1-PLAN-2026-02-25",
    "title": "Substrate PRD v4.1 Delivery Packet Plan",
    "authority": "docs/codex-migration/prd-v4.1-redline-delta.md",
    "generated_at": "2026-02-25",
    "notes": "v4.0 kernel must close before v4.1 governance extensions."
  },
  "packets": [
    {
      "packet_id": "PRD4-00-SCOPE-MATRIX",
      "wbs_refs": ["4.1", "17.0"],
      "title": "Publish normative phase scope matrix",
      "purpose": "Eliminate roadmap ambiguity by defining MUST/MUST NOT capability boundaries for v4.0-v4.3.",
      "status": "PENDING",
      "owner": "codex",
      "priority": "CRITICAL",
      "preconditions": [],
      "required_inputs": [
        "docs/codex-migration/prd-v4.1-redline-delta.md"
      ],
      "required_actions": [
        "Add Section 4.1 scope matrix to PRD v4.1",
        "Align roadmap text with matrix constraints",
        "Add release-gate rule that MUST NOT scope cannot block phase closeout"
      ],
      "required_outputs": [
        "PRD v4.1 updated scope matrix section",
        "Roadmap section aligned with phase matrix"
      ],
      "validation_checks": [
        "Manual cross-check: Section 4.1 and Section 17 contain no phase conflicts"
      ],
      "exit_criteria": [
        "Scope matrix is normative and conflict-free"
      ],
      "halt_conditions": [
        "Unresolved conflicts between versioning and roadmap"
      ]
    },
    {
      "packet_id": "PRD4-01-SHARED-CORE-CONTRACT",
      "wbs_refs": ["6.0"],
      "title": "Enforce shared-core decision contract across surfaces",
      "purpose": "Prevent CLI/API/terminal divergence by formalizing and testing one transition authority envelope.",
      "status": "PENDING",
      "owner": "codex",
      "priority": "CRITICAL",
      "preconditions": [
        "PRD4-00-SCOPE-MATRIX complete"
      ],
      "required_inputs": [
        "src/governed_platform/governance/engine.py",
        ".governance/wbs_cli.py",
        ".governance/wbs_server.py"
      ],
      "required_actions": [
        "Define transition result envelope",
        "Route CLI/API/terminal through same core decision path",
        "Add parity tests for identical inputs across surfaces"
      ],
      "required_outputs": [
        "Shared decision envelope contract doc",
        "Parity test suite and baseline report"
      ],
      "validation_checks": [
        "Automated parity tests for claim/done/fail/note transitions"
      ],
      "exit_criteria": [
        "All surfaces emit equivalent decisions and reason codes"
      ],
      "halt_conditions": [
        "Any parity mismatch on deterministic test fixtures"
      ]
    },
    {
      "packet_id": "PRD4-02-ONTOLOGY-MINIMUM",
      "wbs_refs": ["7.0"],
      "title": "Implement v4.0 typed ontology minimum set",
      "purpose": "Deliver kernel entity and relationship typing required for deterministic governance paths.",
      "status": "PENDING",
      "owner": "codex",
      "priority": "HIGH",
      "preconditions": [
        "PRD4-00-SCOPE-MATRIX complete"
      ],
      "required_inputs": [
        "PRD v4.1 Section 7"
      ],
      "required_actions": [
        "Define core entity types and relationship constraints",
        "Implement schema-level validation for relationship semantics",
        "Reject invalid type/relationship combinations at transition time"
      ],
      "required_outputs": [
        "Ontology type registry",
        "Relationship validator test fixtures"
      ],
      "validation_checks": [
        "Unit tests for type constraints and relationship enforcement"
      ],
      "exit_criteria": [
        "Invalid relationships are rejected deterministically"
      ],
      "halt_conditions": [
        "Typed constraints bypassed by any transition surface"
      ]
    },
    {
      "packet_id": "PRD4-03-CONSTRAINT-PIPELINE",
      "wbs_refs": ["8.0"],
      "title": "Implement deterministic constraint pipeline",
      "purpose": "Enforce dependency/policy/risk/integrity checks as ordered deterministic gates.",
      "status": "PENDING",
      "owner": "codex",
      "priority": "CRITICAL",
      "preconditions": [
        "PRD4-01-SHARED-CORE-CONTRACT complete",
        "PRD4-02-ONTOLOGY-MINIMUM complete"
      ],
      "required_inputs": [
        "PRD v4.1 Sections 8.1 and 8.2"
      ],
      "required_actions": [
        "Implement ordered transition validation stages",
        "Implement invariants: no cycles, no gate bypass, no audit mutation",
        "Fail transition atomically on first hard deny"
      ],
      "required_outputs": [
        "Constraint evaluation pipeline module",
        "Invariant conformance tests"
      ],
      "validation_checks": [
        "Deterministic replay test with identical outcomes"
      ],
      "exit_criteria": [
        "Pipeline is deterministic and invariant-complete for v4.0"
      ],
      "halt_conditions": [
        "Non-deterministic outcome under repeated identical inputs"
      ]
    },
    {
      "packet_id": "PRD4-04-POLICY-ENGINE-BASE",
      "wbs_refs": ["9.0"],
      "title": "Ship native policy engine with precedence trace",
      "purpose": "Provide fail-closed policy gating with auditable per-rule decision traces.",
      "status": "PENDING",
      "owner": "codex",
      "priority": "CRITICAL",
      "preconditions": [
        "PRD4-03-CONSTRAINT-PIPELINE complete"
      ],
      "required_inputs": [
        "PRD v4.1 Section 9",
        "docs/codex-migration/prd-v4.1-redline-delta.md"
      ],
      "required_actions": [
        "Implement policy precedence order",
        "Implement fail-closed behavior for unknown/missing policy states",
        "Emit policy trace fields in transition/audit records"
      ],
      "required_outputs": [
        "Policy evaluator with precedence resolver",
        "Policy trace schema and fixture samples"
      ],
      "validation_checks": [
        "Policy conflict tests verify higher-precedence deny dominates"
      ],
      "exit_criteria": [
        "Policy decisions are deterministic, fail-closed, and fully traceable"
      ],
      "halt_conditions": [
        "Any allow decision produced with missing policy version"
      ]
    },
    {
      "packet_id": "PRD4-05-GRAPH-CORE-POSTGRES",
      "wbs_refs": ["11.0"],
      "title": "Implement PostgreSQL graph core and traversal APIs",
      "purpose": "Provide production graph persistence and deterministic traversal primitives for governance operations.",
      "status": "PENDING",
      "owner": "codex",
      "priority": "HIGH",
      "preconditions": [
        "PRD4-02-ONTOLOGY-MINIMUM complete"
      ],
      "required_inputs": [
        "PRD v4.1 Section 11"
      ],
      "required_actions": [
        "Implement adjacency-list schema and indexes",
        "Implement recursive CTE traversal endpoints",
        "Implement cycle detection and impact analysis queries"
      ],
      "required_outputs": [
        "PostgreSQL graph schema",
        "Traversal API contract tests"
      ],
      "validation_checks": [
        "Traversal correctness tests on 1k-10k fixture graphs"
      ],
      "exit_criteria": [
        "Traversal and cycle checks operate within target scale envelope"
      ],
      "halt_conditions": [
        "Traversal correctness fails on reference fixtures"
      ]
    },
    {
      "packet_id": "PRD4-06-IMMUTABLE-AUDIT",
      "wbs_refs": ["12.0", "15.0"],
      "title": "Implement immutable audit and provenance chain",
      "purpose": "Guarantee append-only governance evidence with queryable provenance lineage.",
      "status": "PENDING",
      "owner": "codex",
      "priority": "CRITICAL",
      "preconditions": [
        "PRD4-01-SHARED-CORE-CONTRACT complete",
        "PRD4-04-POLICY-ENGINE-BASE complete"
      ],
      "required_inputs": [
        "PRD v4.1 Sections 6 and 15"
      ],
      "required_actions": [
        "Implement append-only audit record persistence",
        "Link transitions to provenance chain entries",
        "Block mutation paths for historical audit records"
      ],
      "required_outputs": [
        "Audit append-only storage layer",
        "Provenance export endpoint and evidence report"
      ],
      "validation_checks": [
        "Mutation-attempt tests prove audit immutability"
      ],
      "exit_criteria": [
        "Audit mutation attempts are denied and logged"
      ],
      "halt_conditions": [
        "Any successful mutation of historical audit event"
      ]
    },
    {
      "packet_id": "PRD4-07-KERNEL-DOD-E2E",
      "wbs_refs": ["19.0"],
      "title": "Demonstrate v4.0 kernel Definition of Done",
      "purpose": "Run end-to-end kernel scenario from clean clone within 30 minutes and capture evidence.",
      "status": "PENDING",
      "owner": "codex",
      "priority": "CRITICAL",
      "preconditions": [
        "PRD4-03-CONSTRAINT-PIPELINE complete",
        "PRD4-04-POLICY-ENGINE-BASE complete",
        "PRD4-05-GRAPH-CORE-POSTGRES complete",
        "PRD4-06-IMMUTABLE-AUDIT complete"
      ],
      "required_inputs": [
        "docker-compose.yml",
        "Kernel API/CLI adapters"
      ],
      "required_actions": [
        "Execute clean-start kernel scenario",
        "Capture reproducible evidence artifacts",
        "Publish kernel DoD report with timings"
      ],
      "required_outputs": [
        "Kernel DoD runbook and report",
        "Audit and provenance export artifacts"
      ],
      "validation_checks": [
        "Independent rerun by second operator reproduces report"
      ],
      "exit_criteria": [
        "Kernel DoD succeeds within 30 minutes"
      ],
      "halt_conditions": [
        "DoD requires extension-only capabilities to pass"
      ]
    },
    {
      "packet_id": "PRD4-08-POLICY-VERSIONING",
      "wbs_refs": ["9.0", "12.0"],
      "title": "Add policy versioning and activation controls (v4.1)",
      "purpose": "Extend policy governance with immutable version activation, precedence history, and rationale capture.",
      "status": "PENDING",
      "owner": "codex",
      "priority": "HIGH",
      "preconditions": [
        "PRD4-07-KERNEL-DOD-E2E complete"
      ],
      "required_inputs": [
        "PRD v4.1 Sections 9 and 12"
      ],
      "required_actions": [
        "Implement policy version records and activation workflow",
        "Require rationale and approval metadata for activation",
        "Integrate version references into transition trace output"
      ],
      "required_outputs": [
        "Policy version registry",
        "Version activation audit report"
      ],
      "validation_checks": [
        "Attempting mutation of active policy version is denied"
      ],
      "exit_criteria": [
        "Policy versioning is immutable once active"
      ],
      "halt_conditions": [
        "Active policy version can be edited in place"
      ]
    },
    {
      "packet_id": "PRD4-09-TRUST-SCORING-V1",
      "wbs_refs": ["10.0"],
      "title": "Implement deterministic trust scoring v1 (v4.1)",
      "purpose": "Deliver governed explainable trust scoring with versioned weights and approval records.",
      "status": "PENDING",
      "owner": "codex",
      "priority": "HIGH",
      "preconditions": [
        "PRD4-07-KERNEL-DOD-E2E complete",
        "PRD4-08-POLICY-VERSIONING complete"
      ],
      "required_inputs": [
        "PRD v4.1 Section 10"
      ],
      "required_actions": [
        "Define trust model schema with version and rationale fields",
        "Implement deterministic trust computation pipeline",
        "Enforce governance approval on trust model changes"
      ],
      "required_outputs": [
        "Trust scoring model v1 artifacts",
        "Change approval and audit trail records"
      ],
      "validation_checks": [
        "Same inputs produce same trust score across repeated runs"
      ],
      "exit_criteria": [
        "Trust scoring is deterministic, explainable, and versioned"
      ],
      "halt_conditions": [
        "Opaque or non-auditable trust score path detected"
      ]
    },
    {
      "packet_id": "PRD4-10-OPA-COMPAT-ADAPTER",
      "wbs_refs": ["9.0"],
      "title": "Implement OPA compatibility adapter (v4.1)",
      "purpose": "Provide optional OPA evaluation path while preserving native deterministic policy semantics.",
      "status": "PENDING",
      "owner": "codex",
      "priority": "MEDIUM",
      "preconditions": [
        "PRD4-08-POLICY-VERSIONING complete"
      ],
      "required_inputs": [
        "PRD v4.1 Section 9"
      ],
      "required_actions": [
        "Implement OPA adapter and mapping contract",
        "Enforce deterministic fallback when OPA is unavailable",
        "Capture OPA decision traces in audit-compatible format"
      ],
      "required_outputs": [
        "OPA adapter contract and implementation",
        "Fallback behavior test report"
      ],
      "validation_checks": [
        "OPA-offline tests confirm fail-closed or deterministic fallback policy"
      ],
      "exit_criteria": [
        "OPA path is compatible without breaking deterministic core"
      ],
      "halt_conditions": [
        "OPA adapter introduces divergent policy decisions vs native baseline"
      ]
    },
    {
      "packet_id": "PRD4-11-SNAPSHOT-DIFF",
      "wbs_refs": ["6.0", "11.0", "12.0"],
      "title": "Implement state snapshot and diff (v4.1)",
      "purpose": "Enable governed state comparison for audit and operations without mutating history.",
      "status": "PENDING",
      "owner": "codex",
      "priority": "MEDIUM",
      "preconditions": [
        "PRD4-07-KERNEL-DOD-E2E complete",
        "PRD4-06-IMMUTABLE-AUDIT complete"
      ],
      "required_inputs": [
        "PRD v4.1 Sections 6, 11, and 12"
      ],
      "required_actions": [
        "Implement snapshot capture API",
        "Implement deterministic diff output",
        "Link snapshot/diff events into audit log"
      ],
      "required_outputs": [
        "Snapshot/diff API and usage guide",
        "Deterministic snapshot replay fixtures"
      ],
      "validation_checks": [
        "Repeated diff on same snapshot pair is byte-equivalent"
      ],
      "exit_criteria": [
        "Snapshot/diff is deterministic and auditable"
      ],
      "halt_conditions": [
        "Snapshot or diff mutates prior audit records"
      ]
    },
    {
      "packet_id": "PRD4-12-REFERENCE-ONTOLOGY-V1",
      "wbs_refs": ["7.3"],
      "title": "Publish reference ontology pack v1 contract (v4.1)",
      "purpose": "Define the extension boundary for commercial domain ontologies without contaminating kernel scope.",
      "status": "PENDING",
      "owner": "codex",
      "priority": "MEDIUM",
      "preconditions": [
        "PRD4-07-KERNEL-DOD-E2E complete"
      ],
      "required_inputs": [
        "PRD v4.1 Section 7.3"
      ],
      "required_actions": [
        "Define ontology pack ingestion contract",
        "Define compatibility/versioning constraints",
        "Define licensing boundary metadata model"
      ],
      "required_outputs": [
        "Reference ontology pack contract",
        "Compatibility validation checklist"
      ],
      "validation_checks": [
        "Contract validates at least one sample ontology pack"
      ],
      "exit_criteria": [
        "Ontology pack boundary and compatibility are explicit and testable"
      ],
      "halt_conditions": [
        "Commercial ontology assumptions leak into kernel MUST scope"
      ]
    }
  ],
  "dependencies": {
    "PRD4-01-SHARED-CORE-CONTRACT": [
      "PRD4-00-SCOPE-MATRIX"
    ],
    "PRD4-02-ONTOLOGY-MINIMUM": [
      "PRD4-00-SCOPE-MATRIX"
    ],
    "PRD4-03-CONSTRAINT-PIPELINE": [
      "PRD4-01-SHARED-CORE-CONTRACT",
      "PRD4-02-ONTOLOGY-MINIMUM"
    ],
    "PRD4-04-POLICY-ENGINE-BASE": [
      "PRD4-03-CONSTRAINT-PIPELINE"
    ],
    "PRD4-05-GRAPH-CORE-POSTGRES": [
      "PRD4-02-ONTOLOGY-MINIMUM"
    ],
    "PRD4-06-IMMUTABLE-AUDIT": [
      "PRD4-01-SHARED-CORE-CONTRACT",
      "PRD4-04-POLICY-ENGINE-BASE"
    ],
    "PRD4-07-KERNEL-DOD-E2E": [
      "PRD4-03-CONSTRAINT-PIPELINE",
      "PRD4-04-POLICY-ENGINE-BASE",
      "PRD4-05-GRAPH-CORE-POSTGRES",
      "PRD4-06-IMMUTABLE-AUDIT"
    ],
    "PRD4-08-POLICY-VERSIONING": [
      "PRD4-07-KERNEL-DOD-E2E"
    ],
    "PRD4-09-TRUST-SCORING-V1": [
      "PRD4-07-KERNEL-DOD-E2E",
      "PRD4-08-POLICY-VERSIONING"
    ],
    "PRD4-10-OPA-COMPAT-ADAPTER": [
      "PRD4-08-POLICY-VERSIONING"
    ],
    "PRD4-11-SNAPSHOT-DIFF": [
      "PRD4-07-KERNEL-DOD-E2E",
      "PRD4-06-IMMUTABLE-AUDIT"
    ],
    "PRD4-12-REFERENCE-ONTOLOGY-V1": [
      "PRD4-07-KERNEL-DOD-E2E"
    ]
  }
}
